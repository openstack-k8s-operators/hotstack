<!--
// Assisted by watsonx Code Assistant
// Code generated by WCA@IBM in this programming language is not approved for
// use in IBM product development.
-->
# Cloud images

This Makefile automates the process of building cloud images for hotstack
deployments. The tasks are executed using the `make` utility.

## Images

- **controller**: A customized CentOS 9 Stream image with packages needed for
  the hotstack controller node
- **blank**: A minimal blank image used for virtual baremetal node disks with
  Redfish virtual BMC
- **nat64**: A NAT64 appliance image built using ci-framework for IPv6-only
  environments
- **switch-host** (experimental): A CentOS 9 Stream image with libvirt/qemu for
  running virtual network switches using nested virtualization

## Variables

- `CONTROLLER_IMAGE_URL`: The URL to download the CentOS 9 Stream controller
  image.
- `CONTROLLER_IMAGE_NAME`: The name of the downloaded image file.
- `CONTROLLER_IMAGE_FORMAT`: The desired format for the controller image
  (default: `raw`). Set to `qcow2` to keep the original format.
- `CONTROLLER_INSTALL_PACKAGES`: A list of packages to install on the
  controller image.
- `BLANK_IMAGE_NAME`: The name of the blank image file to be created.
- `BLANK_IMAGE_FORMAT`: The format for the blank image (default: `raw`). Can be
  set to `qcow2` or any format supported by `qemu-img`.
- `BLANK_IMAGE_SIZE`: The size of the blank image file in megabytes.
- `NAT64_IMAGE_NAME`: The name of the NAT64 appliance image file.
- `NAT64_IMAGE_FORMAT`: The desired format for the NAT64 image (default: `raw`).
  Set to `qcow2` to keep the original format.
- `NAT64_CIFMW_DIR`: Directory where ci-framework will be cloned (default:
  `.ci-framework`).
- `NAT64_BASEDIR`: Build directory for NAT64 appliance artifacts (default:
  `.nat64-build`).
- `SWITCH_HOST_IMAGE_URL`: The URL to download the CentOS 9 Stream image for
  switch host.
- `SWITCH_HOST_IMAGE_NAME`: The name of the switch host image file.
- `SWITCH_HOST_IMAGE_FORMAT`: The desired format for the switch host image
  (default: `raw`). Set to `qcow2` to keep the original format.
- `SWITCH_HOST_INSTALL_PACKAGES`: A list of packages to install on the switch
  host image (includes libvirt, qemu-kvm, networking tools).
- `FORCE10_10_IMAGE`: Path to Force10 OS10 image file (zip archive like
  `OS10_Virtualization_10.6.0.2.74V.zip`). Will be copied to `/opt/force10_10/`
  in the image. (Experimental support only)

**Note**: Raw format is required for cloud backends using Ceph, as Ceph cannot
directly use qcow2 images for VM disks.

## Targets

- `all`: The default target that depends on `controller`, `blank`, and `nat64`.
- `clean`: A target that removes the controller, blank, and NAT64 images, as
  well as build artifacts.
- `controller`: A target that depends on `controller_download`,
  `controller_customize`, and `controller_convert`.
  - `controller_download`: A target that downloads the controller image from
    the specified URL.
  - `controller_customize`: A target that customizes the downloaded image by
    installing the specified packages and relabeling SELinux.
  - `controller_convert`: A target that converts the image to the format
    specified by `CONTROLLER_IMAGE_FORMAT` (in-place conversion if `raw`).
  - `controller_clean`: A target that removes the controller image file.
- `blank`: A target that creates a blank image file of the specified size in the
  format specified by `BLANK_IMAGE_FORMAT`.
- `blank_clean`: A target that removes the blank image file.
- `nat64`: A target that depends on `nat64_setup`, `nat64_build`, and
  `nat64_convert`.
  - `nat64_setup`: A target that clones ci-framework and sets up the molecule
    environment with required dependencies.
  - `nat64_build`: A target that builds the NAT64 appliance image using the
    `build-nat64-appliance-image.yaml` playbook and the ci-framework
    nat64_appliance role.
  - `nat64_convert`: A target that converts the image to the format specified by
    `NAT64_IMAGE_FORMAT` (in-place conversion if `raw`).
  - `nat64_clean`: A target that removes the NAT64 image and build artifacts.
- `switch-host` (experimental): A standalone target that depends on
  `switch-host_download`, `switch-host_customize`, and `switch-host_convert`.
  Not included in `all` or `clean` targets.
  - `switch-host_download`: A target that downloads the base image from the
    specified URL.
  - `switch-host_customize`: A target that customizes the downloaded image by
    installing packages (libvirt, qemu, networking tools), copying helper
    scripts to `/usr/local/bin/`, installing the systemd service, and creating
    necessary directories.
  - `switch-host_convert`: A target that converts the image to the format
    specified by `SWITCH_HOST_IMAGE_FORMAT` (in-place conversion if `raw`).
  - `switch-host_clean`: A target that removes the switch-host image file.

## Examples

### Cleanup

```shell
make clean
```

### Building and uploading the controller image to glance

1. Build the controller image:

   ```shell
   make controller
   ```

2. Upload the controller image to Glance:

   ```shell
   openstack image create hotstack-controller \
     --disk-format raw \
     --file controller.qcow2
   ```

### Building and uploading the blank image to glance

1. Create the blank image:

   ```shell
   make blank
   ```

2. Upload the blank image to Glance:

   ```shell
   openstack image create sushy-tools-blank-image \
     --disk-format raw \
     --file blank-image.qcow2 \
     --property hw_firmware_type=uefi \
     --property hw_machine_type=q35 \
     --property os_shutdown_timeout=5
   ```

### Building and uploading the NAT64 appliance image to glance

1. Build the NAT64 appliance image:

   ```shell
   make nat64
   ```

   This will:
   - Clone the ci-framework repository (if not already present)
   - Setup the molecule environment with required dependencies
   - Run the `build-nat64-appliance-image.yaml` playbook using the
     nat64_appliance role
   - Copy the resulting image to `nat64-appliance.qcow2`

2. Upload the NAT64 appliance image to Glance:

   ```shell
   openstack image create nat64-appliance \
     --disk-format raw \
     --file nat64-appliance.qcow2 \
     --property hw_firmware_type=uefi \
     --property hw_machine_type=q35
   ```

   **Note**: The NAT64 image build process requires the ci-framework and its
   dependencies. The build artifacts are stored in `.nat64-build`, the
   ci-framework clone is stored in `.ci-framework`, and a Python virtual
   environment is created at `~/test-python`. All of these can be cleaned up
   with `make nat64_clean`.

### Building and uploading the switch-host image to glance

1. Build the switch-host image:

   ```shell
   make switch-host
   ```

   Or with vendor switch images pre-installed:

   ```shell
   make switch-host \
     FORCE10_10_IMAGE=/path/to/OS10_Virtualization_10.6.0.2.74V.zip
   ```

   This will:
   - Download CentOS 9 Stream image
   - Install libvirt, qemu-kvm, and networking tools
   - Copy helper scripts to `/usr/local/bin/`
   - Install systemd service for managing nested switch VMs
   - Create directories for each switch model under `/opt/`
   - Copy any provided vendor switch images to their respective directories

2. Upload the switch-host image to Glance:

   ```shell
   openstack image create hotstack-virtual-switch-host \
     --disk-format raw \
     --file switch-host.qcow2 \
     --property hw_firmware_type=uefi \
     --property hw_machine_type=q35
   ```

   See `switch-host-scripts/README.md` for details on switch image requirements
   and configuration.
