---
# Copyright Red Hat, Inc.
# All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Display retry metrics summary
  vars:
    _total_retries: >-
      {{
        hotloop_retry_metrics
        | map(attribute='retry_count')
        | map('int')
        | sum
      }}
    _total_retry_time: >-
      {{
        hotloop_retry_metrics
        | map(attribute='retry_time')
        | map('int')
        | sum
      }}
    _stages_with_retries: "{{ hotloop_retry_metrics | length }}"
  ansible.builtin.debug:
    msg: |

      ╔══════════════════════════════════════════════════════════════════╗
      ║            HOTLOOP RETRY METRICS SUMMARY                         ║
      ╚══════════════════════════════════════════════════════════════════╝

      Total Stages with Retries: {{ _stages_with_retries }}
      Total Retry Attempts:      {{ _total_retries }}
      Total Retry Time:          {{ _total_retry_time }}s

      {% for metric in hotloop_retry_metrics %}
      ┌─ Stage: {{ metric.stage }}
      │  Type:     {{ metric.type }}
      │  Resource: {{ metric.file | default(metric.directory | default('N/A')) }}
      │  Retries:  {{ metric.retry_count }}
      │  Time:     {{ metric.retry_time }}s
      └─
      {% endfor %}
