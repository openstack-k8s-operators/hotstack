---
- name: Common OLM Dependencies
  documentation: |
    Install the OpenStack K8S dependencies. (Namespaces, OperatorGroup, and Subscription CRs.)

    Once these CRs are created, run the `oc wait` commands to confirm that
    each step of this procedure is complete.
  manifest: "{{ role_path }}/files/common/manifests/deps/olm-deps.yaml"
  wait_conditions:
    - "oc wait namespaces cert-manager-operator --for jsonpath='{.status.phase}'=Active --timeout=30s"
    - "oc wait namespaces metallb-system --for jsonpath='{.status.phase}'=Active --timeout=30s"
    - "oc wait namespaces openshift-nmstate --for jsonpath='{.status.phase}'=Active --timeout=30s"

- name: Wait for OLM dependency CSVs
  documentation: |
    Wait for the ClusterServiceVersions (CSVs) to reach 'Succeeded' phase.
    This ensures OLM has finished installing the operators and their deployments exist.
  wait_conditions:
    - >-
      oc wait -n metallb-system csv -l operators.coreos.com/metallb-operator.metallb-system=
      --for jsonpath='{.status.phase}'=Succeeded --timeout=300s
    - >-
      oc wait -n cert-manager-operator csv -l operators.coreos.com/openshift-cert-manager-operator.cert-manager-operator=
      --for jsonpath='{.status.phase}'=Succeeded --timeout=300s
    - >-
      oc wait -n openshift-nmstate csv -l operators.coreos.com/kubernetes-nmstate-operator.openshift-nmstate=
      --for jsonpath='{.status.phase}'=Succeeded --timeout=300s

- name: Wait for OLM dependency deployments
  documentation: |
    Wait for operator deployments to become available.
    At this point, the CSVs are succeeded and deployments should exist.
  wait_conditions:
    - "oc wait -n metallb-system deployment -l control-plane=controller-manager --for condition=Available --timeout=180s"
    - "oc wait -n metallb-system deployment -l component=webhook-server --for condition=Available --timeout=180s"
    - "oc wait -n cert-manager-operator deployment cert-manager-operator-controller-manager --for condition=Available --timeout=180s"
    - "oc wait -n cert-manager deployment -l app=cainjector --for condition=Available --timeout=180s"
    - "oc wait -n cert-manager deployment -l app=webhook --for condition=Available --timeout=180s"
    - "oc wait -n cert-manager deployment -l app=cert-manager --for condition=Available --timeout=180s"

- name: Common MetalLB
  manifest: "{{ role_path }}/files/common/manifests/deps/metallb.yaml"

- name: Common NMState
  manifest: "{{ role_path }}/files/common/manifests/deps/nmstate.yaml"

- name: Wait for MetalLB and NMState
  wait_conditions:
    - "oc wait -n metallb-system daemonset -l component=speaker --for jsonpath='{.status.numberReady}'=1 --timeout=180s"
    - "oc wait -n openshift-nmstate daemonset -l component=kubernetes-nmstate-handler --for jsonpath='{.status.numberReady}'=1 --timeout=180s"
    - "oc wait -n openshift-nmstate deployment -l component=kubernetes-nmstate-webhook --for condition=Available --timeout=180s"
