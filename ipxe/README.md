<!--
// Assisted by watsonx Code Assistant
// Code generated by WCA@IBM in this programming language is not approved for
// use in IBM product development.
-->
# IPXE image-building tools

This Makefile automates the process of building customized iPXE images for
different use cases, such as booting from USB, ISO, or EFI. The Makefile allows
for custom configuration of iPXE by embedding a custom script (`script.ipxe`)
and copying local configuration headers from `ipxe-config/` into the iPXE
source directory.

## Build dependencies

To build the iPXE images, you need to install the following dependencies using
`dnf`:

- `gcc`
- `xorriso`
- `make`
- `qemu-img`
- `syslinux-nonlinux`
- `xz-devel`
- `guestfs-tools`
- `perl`

To install these dependencies, run the following command:

```bash
sudo dnf install -y gcc xorriso make qemu-img syslinux-nonlinux xz-devel guestfs-tools perl
```

## Variables

- `IPXE_SRCDIR`: The directory containing the iPXE source code.
- `IPXE_ISO`, `IPXE_USB`, `IPXE_EFI`: The specific iPXE images to use as the
  boot image for ISO, USB, and EFI formats, respectively.
- `ipxe_iso_path`, `ipxe_usb_path`, `ipxe_efi_path`: The paths to the iPXE
  images in the source directory.

## Targets

- `all`: The default target that builds all three formats (efi.img,
  ipxe-boot.iso, and ipxe-boot-usb.raw).
- `efi.img`: Creates an EFI image by copying the iPXE EFI binary to a FAT
  filesystem and creating a raw image.
- `ipxe-boot.iso`: Creates an ISO image by extracting the contents of the iPXE
  ISO, adding the EFI image, and creating a hybrid ISO image that can be booted
  from both BIOS and UEFI.
- `ipxe-boot-usb.raw`: Simply copies the iPXE USB image to a raw file.
- `clean`: Removes all generated files and the iPXE source code directory.

## Examples

### Building the iPXE Images

1. Build the iPXE images:

   ```shell
   make
   ```

2. To build a specific image, use:

   ```shell
   make efi.img
   make ipxe-boot.iso
   make ipxe-boot-usb.raw
   ```

### Uploading the iPXE Images to Glance

1. Upload the ISO image to Glance:

   ```shell
   openstack image create --disk-format=iso --file ipxe-boot.img ipxe-iso-image \
     --property os_shutdown_timeout=5 \
     --property hw_firmware_type=uefi \
     --property hw_machine_type=q35
   ```

2. Upload the BIOS image to Glance:

   ```shell
   openstack image create --disk-format=raw --file ipxe-boot-usb.raw ipxe-boot-usb \
     --property os_shutdown_timeout=5
   ```
