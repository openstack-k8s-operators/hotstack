---
heat_template_version: rocky

description: >
  Heat template to set up SNO + 2x BaremetalHosts with IPv6

parameters:
  dns_servers:
    type: comma_delimited_list
    default:
      - 8.8.8.8
      - 8.8.4.4
  ntp_servers:
    type: comma_delimited_list
    default: []
  controller_ssh_pub_key:
    type: string
  dataplane_ssh_pub_key:
    type: string
  controller_params:
    type: json
    default:
      image: hotstack-controller
      flavor: hotstack.small
  nat64_appliance_params:
    type: json
    default:
      image: nat64-appliance
      flavor: hotstack.small
  ocp_master_params:
    type: json
    default:
      image: ipxe-boot-usb
      flavor: hotstack.xxlarge
  bmh_params:
    type: json
    default:
      image: CentOS-Stream-GenericCloud-9
      cd_image: sushy-tools-blank-image
      flavor: hotstack.medium
  router_external_network:
    type: string
    default: public
  floating_ip_network:
    type: string
    default: public
  net_value_specs:
    type: json
    default: {}
  cdrom_disk_bus:
    type: string
    description: >
      Disk bus type for CDROM device. 'sata' may be required for older versions
      of OpenStack. Heat patch https://review.opendev.org/c/openstack/heat/+/966688
      is needed for 'sata' support.
    default: scsi
    constraints:
      - allowed_values:
          - sata
          - scsi


resources:
  #
  # Networks
  #
  nat64-ipv4-net:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  nat64-ipv6-net:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  machine-net:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  ctlplane-net-0:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  ctlplane-net-1:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  internal-api-net:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  storage-net:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  tenant-net:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  provisioning-net-0:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  provisioning-net-1:
    type: OS::Neutron::Net
    properties:
      port_security_enabled: false
      value_specs: {get_param: net_value_specs}

  #
  # Subnets
  #
  nat64-ipv4-subnet:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: nat64-ipv4-net}
      ip_version: 4
      cidr: 192.168.254.0/24
      enable_dhcp: true

  nat64-ipv6-subnet:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: nat64-ipv6-net}
      ip_version: 6
      cidr: "fc00:abcd:abcd:fc00::/64"
      enable_dhcp: false
      gateway_ip: "fc00:abcd:abcd:fc00::1"

  machine-subnet-ipv4:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: machine-net}
      ip_version: 4
      cidr: "192.168.32.0/24"
      enable_dhcp: true
      dns_nameservers:
        - "192.168.32.254"

  machine-subnet:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: machine-net}
      ip_version: 6
      cidr: "2620:cf:cf:cf02::/64"
      gateway_ip: "2620:cf:cf:cf02::1"
      ipv6_address_mode: dhcpv6-stateful
      ipv6_ra_mode: dhcpv6-stateful
      dns_nameservers:
        - "2620:cf:cf:cf02::fff0"

  ctlplane-subnet-0:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: ctlplane-net-0}
      ip_version: 6
      cidr: "2620:cf:cf:aaaa::/64"
      gateway_ip: "2620:cf:cf:aaaa::1"
      enable_dhcp: false
      allocation_pools:
        - start: "2620:cf:cf:aaaa::f100"
          end: "2620:cf:cf:aaaa::f150"
      dns_nameservers:
        - "2620:cf:cf:aaaa::80"

  ctlplane-subnet-1:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: ctlplane-net-1}
      ip_version: 6
      cidr: "2620:cf:cf:aaab::/64"
      gateway_ip: "2620:cf:cf:aaab::1"
      enable_dhcp: false
      allocation_pools:
        - start: "2620:cf:cf:aaab::f100"
          end: "2620:cf:cf:aaab::f150"
      dns_nameservers:
        - "2620:cf:cf:aaaa::80"

  internal-api-subnet:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: internal-api-net}
      ip_version: 6
      cidr: "2620:cf:cf:bbbb::/64"
      gateway_ip: "2620:cf:cf:bbbb::1"
      enable_dhcp: false
      allocation_pools:
        - start: "2620:cf:cf:bbbb::f100"
          end: "2620:cf:cf:bbbb::f150"

  storage-subnet:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: storage-net}
      ip_version: 6
      cidr: "2620:cf:cf:cccc::/64"
      gateway_ip: "2620:cf:cf:cccc::1"
      enable_dhcp: false
      allocation_pools:
        - start: "2620:cf:cf:cccc::f100"
          end: "2620:cf:cf:cccc::f150"

  tenant-subnet:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: tenant-net}
      ip_version: 6
      cidr: "2620:cf:cf:eeee::/64"
      gateway_ip: "2620:cf:cf:eeee::1"
      enable_dhcp: false
      allocation_pools:
        - start: "2620:cf:cf:eeee::f100"
          end: "2620:cf:cf:eeee::f150"

  provisioning-subnet-0:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: provisioning-net-0}
      ip_version: 6
      cidr: "2620:cf:cf:aa01::/64"
      gateway_ip: "2620:cf:cf:aa01::1"
      enable_dhcp: true
      ipv6_address_mode: dhcpv6-stateful
      ipv6_ra_mode: dhcpv6-stateful
      allocation_pools:
        - start: "2620:cf:cf:aa01::10"
          end: "2620:cf:cf:aa01::c8"
      dns_nameservers:
        - "2620:cf:cf:cf02::fff0"

  provisioning-subnet-1:
    type: OS::Neutron::Subnet
    properties:
      network: {get_resource: provisioning-net-1}
      ip_version: 6
      cidr: "2620:cf:cf:aa02::/64"
      gateway_ip: "2620:cf:cf:aa02::1"
      enable_dhcp: false
      allocation_pools:
        - start: "2620:cf:cf:aa02::f100"
          end: "2620:cf:cf:aa02::f150"
      dns_nameservers:
        - "2620:cf:cf:cf02::fff0"

  #
  # Routers
  #
  router:
    type: OS::Neutron::Router
    properties:
      admin_state_up: true
      external_gateway_info:
        network: {get_param: router_external_network}

  nat64-ipv4-net-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: router}
      subnet: {get_resource: nat64-ipv4-subnet}

  nat64-router:
    type: OS::Neutron::Router
    properties:
      admin_state_up: true

  nat64-ipv6-net-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: nat64-router}
      subnet: {get_resource: nat64-ipv6-subnet}

  machine-net-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: nat64-router}
      subnet: {get_resource: machine-subnet}

  machine-net-ipv4-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: router}
      subnet: {get_resource: machine-subnet-ipv4}

  ctlplane-net-0-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: nat64-router}
      subnet: {get_resource: ctlplane-subnet-0}

  ctlplane-net-1-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: nat64-router}
      subnet: {get_resource: ctlplane-subnet-1}

  internal-api-net-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: nat64-router}
      subnet: {get_resource: internal-api-subnet}

  provisioning-net-0-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: nat64-router}
      subnet: {get_resource: provisioning-subnet-0}

  provisioning-net-1-router-interface:
    type: OS::Neutron::RouterInterface
    properties:
      router: {get_resource: nat64-router}
      subnet: {get_resource: provisioning-subnet-1}

  # NOTE: Using unsupported OS::Neutron::ExtraRoute instead of
  # OS::Neutron::ExtraRouteSet because OVN and extraroute-atomic ?
  # See: https://etherpad.opendev.org/p/ovn-extraroute-atomic
  nat64-router-extra-routes:
    type: OS::Neutron::ExtraRoute
    properties:
      router_id: {get_resource: nat64-router}
      destination: "::/0"
      nexthop: {get_attr: [nat64-appliance-ipv6, fixed_ips, 0, ip_address]}

  #
  # NAT64 - instance and related resources
  #
  nat64-appliance-ipv4:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: nat64-ipv4-net}

  nat64-appliance-ipv6:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: nat64-ipv6-net}
      fixed_ips:
        - ip_address: "fc00:abcd:abcd:fc00::2"

  # NAT64 Tayga TAP interface IP address allocation. (Port is not bound/attached to instance)
  nat64-appliance-ipv6-tayga:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: nat64-ipv6-net}
      fixed_ips:
        - ip_address: "fc00:abcd:abcd:fc00::3"

  nat64-write-files:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        write_files:
          - path: /etc/nat64/config-data
            owner: root:root
            content:
              str_replace:
                template: |
                  NAT64_IPV6_PREFIX=$nat64_ipv6_prefix
                  NAT64_HOST_IPV6=$nat64_host_ipv6/64
                  NAT64_TAYGA_IPV6=$nat64_tayga_ipv6
                params:
                  $nat64_ipv6_prefix: {get_attr: [nat64-ipv6-subnet, cidr]}
                  $nat64_host_ipv6: {get_attr: [nat64-appliance-ipv6, fixed_ips, 0, ip_address]}
                  $nat64_tayga_ipv6: {get_attr: [nat64-appliance-ipv6-tayga, fixed_ips, 0, ip_address]}

  nat64-appliance-init:
    type: OS::Heat::MultipartMime
    properties:
      parts:
        - config: {get_resource: controller_users}
        - config: {get_resource: nat64-write-files}

  nat64-appliance:
    type: OS::Nova::Server
    properties:
      image: {get_param: [nat64_appliance_params, image]}
      flavor: {get_param: [nat64_appliance_params, flavor]}
      networks:
        - port: {get_resource: nat64-appliance-ipv4}
        - port: {get_resource: nat64-appliance-ipv6}
      user_data_format: RAW
      user_data: {get_resource: nat64-appliance-init}

  #
  # Instances
  #
  controller_users:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        users:
          - default
          - name: zuul
            gecos: "Zuul user"
            sudo: ALL=(ALL) NOPASSWD:ALL
            ssh_authorized_keys:
              - {get_param: controller_ssh_pub_key}

  controller-write-files:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        write_files:
          - path: /etc/dnsmasq.conf
            content: |
              # dnsmasq service config
              # Include all files in /etc/dnsmasq.d except RPM backup files
              conf-dir=/etc/dnsmasq.d,.rpmnew,.rpmsave,.rpmorig
              no-resolv
            owner: root:dnsmasq
          - path: /etc/dnsmasq.d/forwarders.conf
            content:
              str_replace:
                template: |
                  # DNS forwarders records
                  server=$dns1
                params:
                  $dns1: {get_attr: [nat64-appliance-ipv6, fixed_ips, 0, ip_address]}
            owner: root:dnsmasq
          - path: /etc/dnsmasq.d/host_records.conf
            content:
              str_replace:
                template: |
                  # Host records
                  host-record=controller-0.openstack.lab,$controller0
                  host-record=api.sno.openstack.lab,$master0
                  host-record=api-int.sno.openstack.lab,$master0
                  host-record=master-0.sno.openstack.lab,$master0
                params:
                  $controller0: {get_attr: [controller-machine-port, fixed_ips, 0, ip_address]}
                  $master0: {get_attr: [master0-machine-port, fixed_ips, 1, ip_address]}
            owner: root:dnsmasq
          - path: /etc/dnsmasq.d/wildcard_records.conf
            content:
              str_replace:
                template: |
                  # Wildcard records
                  address=/apps.sno.openstack.lab/$addr
                params:
                  $addr: {get_attr: [master0-machine-port, fixed_ips, 1, ip_address]}
            owner: root:dnsmasq
          - path: /etc/resolv.conf
            content: |
              nameserver: 127.0.0.1
            owner: root:root
          - path: /etc/NetworkManager/conf.d/98-rc-manager.conf
            content: |
              [main]
              rc-manager=unmanaged
            owner: root:root
          - path: /etc/haproxy/haproxy.cfg
            content: |
              global
                log         127.0.0.1 local2
                pidfile     /var/run/haproxy.pid
                maxconn     4000
                daemon
              defaults
                mode                    http
                log                     global
                option                  dontlognull
                option                  http-server-close
                option                  redispatch
                retries                 3
                timeout http-request    10s
                timeout queue           1m
                timeout connect         10s
                timeout client          1m
                timeout server          1m
                timeout http-keep-alive 10s
                timeout check           10s
                maxconn                 3000
              listen api-server-6443
                bind *:6443
                mode tcp
                server master-0 master-0.sno.openstack.lab:6443 check inter 1s
              listen machine-config-server-22623
                bind *:22623
                mode tcp
                server master-0 master-0.sno.openstack.lab:22623 check inter 1s
              listen ingress-router-443
                bind *:443
                mode tcp
                balance source
                server master-0 master-0.sno.openstack.lab:443 check inter 1s
              listen ingress-router-80
                bind *:80
                mode tcp
                balance source
                server master-0 master-0.sno.openstack.lab:80 check inter 1s
            owner: root:root

  controller-runcmd:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        runcmd:
          - ['systemctl', 'enable', 'dnsmasq.service']
          - ['systemctl', 'start', 'dnsmasq.service']
          - ['setenforce', 'permissive']
          - ['systemctl', 'enable', 'haproxy.service']
          - ['systemctl', 'start', 'haproxy.service']
          - ['sed', '-i', 's/Listen 80/Listen 8081/g', '/etc/httpd/conf/httpd.conf']
          - ['systemctl', 'enable', 'httpd.service']
          - ['systemctl', 'start', 'httpd.service']

  controller-init:
    type: OS::Heat::MultipartMime
    properties:
      parts:
        - config: {get_resource: controller_users}
        - config: {get_resource: controller-write-files}
        - config: {get_resource: controller-runcmd}

  controller-machine-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: machine-net}
      fixed_ips:
        - subnet: {get_resource: machine-subnet-ipv4}
          ip_address: "192.168.32.254"
        - subnet: {get_resource: machine-subnet}
          ip_address: "2620:cf:cf:cf02::fff0"

  controller-floating-ip:
    depends_on: nat64-ipv4-net-router-interface
    type: OS::Neutron::FloatingIP
    properties:
      floating_network: {get_param: floating_ip_network}
      port_id: {get_resource: controller-machine-port}

  controller:
    type: OS::Nova::Server
    properties:
      image: {get_param: [controller_params, image]}
      flavor: {get_param: [controller_params, flavor]}
      networks:
        - port: {get_resource: controller-machine-port}
      user_data_format: RAW
      user_data: {get_resource: controller-init}

  # OCP Masters

  # DHCP Opts value
  extra-dhcp-opts-value:
    type: OS::Heat::Value
    properties:
      type: json
      value:
        extra_dhcp_opts:
          # IPv4 DHCP options for initial PXE boot
          - opt_name: "60"
            opt_value: "HTTPClient"
            ip_version: 4
          - opt_name: "67"
            opt_value:
              str_replace:
                template: http://$server_address:8081/boot-artifacts/agent.x86_64.ipxe
                params:
                  $server_address: {get_attr: [controller-machine-port, fixed_ips, 0, ip_address]}
            ip_version: 4

  master0-machine-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: machine-net}
      port_security_enabled: false
      fixed_ips:
        - subnet: {get_resource: machine-subnet-ipv4}
          ip_address: "192.168.32.10"
        - subnet: {get_resource: machine-subnet}
          ip_address: "2620:cf:cf:cf02::10"
      value_specs: {get_attr: [extra-dhcp-opts-value, value]}

  master0-ctlplane-trunk-parent-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: ctlplane-net-0}
      port_security_enabled: false
      fixed_ips:
        - ip_address: "2620:cf:cf:aaaa::10"

  master0-internal-api-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: internal-api-net}
      port_security_enabled: false
      fixed_ips:
        - ip_address: "2620:cf:cf:bbbb::10"

  master0-storage-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: storage-net}
      port_security_enabled: false
      fixed_ips:
        - ip_address: "2620:cf:cf:cccc::10"

  master0-tenant-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: tenant-net}
      port_security_enabled: false
      fixed_ips:
        - ip_address: "2620:cf:cf:eeee::10"

  master0-trunk0:
    type: OS::Neutron::Trunk
    properties:
      port: {get_resource: master0-ctlplane-trunk-parent-port}
      sub_ports:
        - port: {get_resource: master0-internal-api-port}
          segmentation_id: 20
          segmentation_type: vlan
        - port: {get_resource: master0-storage-port}
          segmentation_id: 21
          segmentation_type: vlan
        - port: {get_resource: master0-tenant-port}
          segmentation_id: 22
          segmentation_type: vlan

  master0-lvms-vol0:
    type: OS::Cinder::Volume
    properties:
      size: 20

  master0-cinder-vol0:
    type: OS::Cinder::Volume
    properties:
      size: 20

  master0-cinder-vol1:
    type: OS::Cinder::Volume
    properties:
      size: 20

  master0-cinder-vol2:
    type: OS::Cinder::Volume
    properties:
      size: 20

  master0:
    type: OS::Nova::Server
    properties:
      image: {get_param: [ocp_master_params, image]}
      flavor: {get_param: [ocp_master_params, flavor]}
      block_device_mapping_v2:
        - boot_index: -1
          device_type: disk
          volume_id: {get_resource: master0-lvms-vol0}
        - boot_index: -1
          device_type: disk
          volume_id: {get_resource: master0-cinder-vol0}
        - boot_index: -1
          device_type: disk
          volume_id: {get_resource: master0-cinder-vol1}
        - boot_index: -1
          device_type: disk
          volume_id: {get_resource: master0-cinder-vol2}
      networks:
        - port: {get_resource: master0-machine-port}
        - port: {get_attr: [master0-trunk0, port_id]}

  #
  # BaremetalHosts
  #
  bmh0-ctlplane-trunk-parent-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: ctlplane-net-0}
      port_security_enabled: false

  bmh0-internal-api-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: internal-api-net}
      port_security_enabled: false

  bmh0-storage-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: storage-net}
      port_security_enabled: false

  bmh0-tenant-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: tenant-net}
      port_security_enabled: false

  bmh0-provisioning-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: provisioning-net-0}
      port_security_enabled: false

  bmh0-trunk0:
    type: OS::Neutron::Trunk
    properties:
      port: {get_resource: bmh0-ctlplane-trunk-parent-port}
      sub_ports:
        - port: {get_resource: bmh0-internal-api-port}
          segmentation_id: 20
          segmentation_type: vlan
        - port: {get_resource: bmh0-storage-port}
          segmentation_id: 21
          segmentation_type: vlan
        - port: {get_resource: bmh0-tenant-port}
          segmentation_id: 22
          segmentation_type: vlan

  bmh0:
    type: OS::Nova::Server
    properties:
      flavor: {get_param: [bmh_params, flavor]}
      block_device_mapping_v2:
        - device_type: disk
          boot_index: 1
          image_id: {get_param: [bmh_params, image]}
          volume_size: 60
          delete_on_termination: true
        - device_type: cdrom
          disk_bus: {get_param: cdrom_disk_bus}
          boot_index: 0
          image_id: {get_param: [bmh_params, cd_image]}
          volume_size: 5
          delete_on_termination: true
      networks:
        - port: {get_resource: bmh0-provisioning-port}
        - port: {get_resource: bmh0-ctlplane-trunk-parent-port}

  bmh1-ctlplane-trunk-parent-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: ctlplane-net-1}
      port_security_enabled: false

  bmh1-internal-api-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: internal-api-net}
      port_security_enabled: false

  bmh1-storage-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: storage-net}
      port_security_enabled: false

  bmh1-tenant-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: tenant-net}
      port_security_enabled: false

  bmh1-provisioning-port:
    type: OS::Neutron::Port
    properties:
      network: {get_resource: provisioning-net-1}
      port_security_enabled: false

  bmh1-trunk0:
    type: OS::Neutron::Trunk
    properties:
      port: {get_resource: bmh1-ctlplane-trunk-parent-port}
      sub_ports:
        - port: {get_resource: bmh1-internal-api-port}
          segmentation_id: 20
          segmentation_type: vlan
        - port: {get_resource: bmh1-storage-port}
          segmentation_id: 21
          segmentation_type: vlan
        - port: {get_resource: bmh1-tenant-port}
          segmentation_id: 22
          segmentation_type: vlan

  bmh1:
    type: OS::Nova::Server
    properties:
      flavor: {get_param: [bmh_params, flavor]}
      block_device_mapping_v2:
        - device_type: disk
          boot_index: 1
          image_id: {get_param: [bmh_params, image]}
          volume_size: 60
          delete_on_termination: true
        - device_type: cdrom
          disk_bus: {get_param: cdrom_disk_bus}
          boot_index: 0
          image_id: {get_param: [bmh_params, cd_image]}
          volume_size: 5
          delete_on_termination: true
      networks:
        - port: {get_resource: bmh1-provisioning-port}
        - port: {get_resource: bmh1-ctlplane-trunk-parent-port}


outputs:
  controller_floating_ip:
    description: Controller Floating IP
    value: {get_attr: [controller-floating-ip, floating_ip_address]}

  ocp_install_config:
    description: OCP install-config.yaml
    value:
      apiVersion: v1
      baseDomain: openstack.lab
      controlPlane:
        architecture: amd64
        hyperthreading: Disabled
        name: master
        replicas: 1
      compute:
        - architecture: amd64
          hyperthreading: Disabled
          name: worker
          replicas: 0
      metadata:
        name: sno
      networking:
        clusterNetwork:
          - cidr: fd01::/48
            hostPrefix: 64
        machineNetwork:
          - cidr: {get_attr: [machine-subnet, cidr]}
        serviceNetwork:
          - fd02::/112
        networkType: OVNKubernetes
      platform:
        none: {}
      pullSecret: _replaced_
      sshKey: {get_param: dataplane_ssh_pub_key}

  ocp_agent_config:
    description: OCP agent-config.yaml
    value:
      apiVersion: v1beta1
      kind: AgentConfig
      metadata:
        name: sno
      rendezvousIP: {get_attr: [master0-machine-port, fixed_ips, 1, ip_address]}
      additionalNTPSources: {get_param: ntp_servers}
      bootArtifactsBaseURL:
        str_replace:
          template: http://$server_address:8081/boot-artifacts
          params:
            $server_address: {get_attr: [controller-machine-port, fixed_ips, 0, ip_address]}
      hosts:
        - hostname: master-0
          role: master
          interfaces:
            - name: eth0
              macAddress: {get_attr: [master0-machine-port, mac_address]}
            - name: eth1
              macAddress: {get_attr: [master0-ctlplane-trunk-parent-port, mac_address]}
          networkConfig:
            interfaces:
              - name: eth0
                type: ethernet
                state: up
                mac-address: {get_attr: [master0-machine-port, mac_address]}
                ipv4:
                  enabled: false
                ipv6:
                  enabled: true
                  address:
                    - ip: {get_attr: [master0-machine-port, fixed_ips, 1, ip_address]}
                      prefix-length: 64
                  dhcp: false
              - name: eth1
                type: ethernet
                state: down
                mac-address: {get_attr: [master0-ctlplane-trunk-parent-port, mac_address]}
            routes:
              config:
                - destination: "::/0"
                  next-hop-interface: eth0
                  next-hop-address: {get_attr: [machine-subnet, gateway_ip]}
                  table-id: 254
            dns-resolver:
              config:
                server:
                  - "2620:cf:cf:cf02::fff0"
  controller_ansible_host:
    description: >
      Controller ansible host, this struct can be passed to the ansible.builtin.add_host module
    value:
      name: controller-0
      ansible_ssh_user: zuul
      ansible_host: {get_attr: [controller-floating-ip, floating_ip_address]}
      ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
      groups: controllers

  sushy_emulator_uuids:
    description: UUIDs of instances to manage with sushy-tools - RedFish virtual BMC
    value:
      bmh0: {get_resource: bmh0}
      bmh1: {get_resource: bmh1}

  ironic_nodes:
    description: Ironic nodes YAML, for enroll in ironic or Metal3 BaremetalHost
    value:
      nodes:
        - name: bmh0
          driver: redfish
          bios_interface: no-bios
          boot_interface: redfish-virtual-media
          driver_info:
            redfish_address: http://sushy-emulator.apps.sno.openstack.lab
            redfish_system_id:
              str_replace:
                template: "/redfish/v1/Systems/$SYS_ID"
                params:
                  $SYS_ID: {get_resource: bmh0}
            redfish_username: admin
            redfish_password: password
          ports:
            - address: {get_attr: [bmh0-provisioning-port, mac_address]}
              physical_network: ctlplane
        - name: bmh1
          driver: redfish
          bios_interface: no-bios
          boot_interface: redfish-virtual-media
          driver_info:
            redfish_address: http://sushy-emulator.apps.sno.openstack.lab
            redfish_system_id:
              str_replace:
                template: "/redfish/v1/Systems/$SYS_ID"
                params:
                  $SYS_ID: {get_resource: bmh1}
            redfish_username: admin
            redfish_password: password
          ports:
            - address: {get_attr: [bmh1-provisioning-port, mac_address]}
              physical_network: ctlplane

  ansible_inventory:
    description: Ansible inventory
    value:
      all:
        children:
          controllers:
            vars:
          ocps:
            vars:
      localhosts:
        hosts:
          localhost:
            ansible_connection: local
      controllers:
        hosts:
          controller0:
            ansible_host: {get_attr: [controller-machine-port, fixed_ips, 0, ip_address]}
            ansible_user: zuul
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
            ansible_ssh_private_key_file: '~/.ssh/id_rsa'
      ocps:
        hosts:
          master0:
            ansible_host: {get_attr: [master0-machine-port, fixed_ips, 0, ip_address]}
            ansible_user: core
            ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
            ansible_ssh_private_key_file: '~/.ssh/id_rsa'
